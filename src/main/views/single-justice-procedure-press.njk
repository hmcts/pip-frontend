{% from "./macros/common-components.njk" import goBack, searchInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{%- from "govuk/components/checkboxes/macro.njk" import govukCheckboxes -%}
{%- from "moj/components/filter/macro.njk" import mojFilter -%}
{%- from "govuk/components/checkboxes/macro.njk" import govukCheckboxes -%}
{%- from "govuk/components/input/macro.njk" import govukInput -%}

{% extends "list-template.njk" %}
{% block pageTitle %}
  {{ title }}
{% endblock %}
{% block beforeContent %}
  {{ super() }}
  {{ goBack(text = backButton) }}
{% endblock %}
{% block content %}
  <h2 id='page-heading' class="govuk-heading-l">{{ header }}</h2>

  <details class="govuk-details" data-module="govuk-details">
    <summary class="govuk-details__summary">
      <span class="govuk-details__summary-text">
      {{ whatIsSJP }}
      </span>
    </summary>
    <div class="govuk-details__text">
      {{ sjpDescription }}
    </div>
  </details>


  <p class="govuk-body govuk-!-font-weight-bold govuk-!-margin-bottom-1">{{ listDate }} {{ contactDate }}</p>
  <p class="govuk-body">{{ published }} {{ publishedDateTime }} {{ publishedAt }} {{ publishedTime }}</p>

  {% if user.roles and user.roles in ['VERIFIED'] %}
    {{ govukButton({
      attributes: {
        id: 'download-button'
      },
      text: downloadButton,
      href: 'list-download-disclaimer?artefactId=' + artefactId
    }) }}
  {% endif %}

  {{ searchInput(text = searchCases) }}

  <button class="govuk-button govuk-button--secondary govuk-!-margin-top-5 hide-show-button" data-module="govuk-button">
    {{ show }}
  </button>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-one-third govuk-!-padding-left-0 govuk-!-padding-right-4", id="filters">
      <div class="filter-form">
        {% set checkedFilters = [] %}
        {% set toBeCreated = true %}
        {% set filterOptionsHtml %}
          {% for key, options in filters %}
            {% set checkedFilterItems = [] %}
            {% set items = [] %}
            {% for item in options %}
              {% set _ = items.push({
                value: item.value,
                text: item.text,
                checked: item.checked
              }) %}
              {% if item.checked %}
                {% set _ = checkedFilterItems.push({href: '?clear=' + item.value, text: item.text}) %}
              {% endif %}
            {% endfor %}

            {% set filterHeader = postcode if key == 'postcodes' else prosecutor %}
            {% if checkedFilterItems | length > 0 %}
              {% set _ = checkedFilters.push({heading: {text: filterHeader}, items: checkedFilterItems}) %}
            {% endif %}

            {% if toBeCreated %}
              <div class="moj-button-menu filters__innerButton" id="innerButton">
                <div class="moj-button-menu__wrapper">
                  <a href="#" role="button" draggable="false"
                     class="govuk-button moj-button-menu__item govuk-button--secondary" data-module="govuk-button"
                     onclick="toggleFilters()">
                    {{ hide }}
                  </a>
                </div>
              </div>
              {% set toBeCreated = false %}
            {% endif %}

            {{ govukCheckboxes({
              idPrefix: key,
              name: key,
              classes: "govuk-checkboxes--small",
              fieldset: {
                legend: {
                  text: filterHeader,
                  classes: 'govuk-fieldset__legend--m'
                }
              },
              items: items
            }) }}
          {% endfor %}
        {% endset %}
        <form method="post" action="sjp-press-list?artefactId={{ artefactId }}" class="moj-filter-layout__filter layout-width-four-fifths"
              autocomplete="off">
        {{ mojFilter({
          heading: {
            text: filter
          },
          selectedFilters: {
            heading: {
              text: selectedFilters
            },

            clearLink: {
              text: clearFilters,
              href: '?clear=all'
            },

            categories: checkedFilters
          },
          optionsHtml: filterOptionsHtml
        }) }}
        </form>
      </div>
    </div>
    <div>
    <div class="parent-box">
      <div class="overflow-table govuk-body search-area">
        {% set hearingCount = 0 %}

        {% for sjpCase in sjpData %}
          {% set hearingCount = hearingCount + 1 %}
          <dl class="govuk-summary-list--no-border">
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                {{ name }}
              </dt>
              <dd class="govuk-summary-list__value">
                {{ sjpCase.name }}
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                {{ dateOfBirth }}
              </dt>
              <dd class="govuk-summary-list__value">
                {{ sjpCase.dob }} ({{ sjpCase.age }})
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                {{ reference }}
              </dt>
              <dd class="govuk-summary-list__value">
                {{ sjpCase.caseUrn }}
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                {{ address }}
              </dt>
              <dd class="govuk-summary-list__value">
                {{ sjpCase.address }}
              </dd>
            </div>
            <div class="govuk-summary-list__row">
              <dt class="govuk-summary-list__key">
                {{ prosecutor }}
              </dt>
              <dd class="govuk-summary-list__value">
                {{ sjpCase.organisationName }}
              </dd>
            </div>

            {% for offence in sjpCase.offences %}
              <p class="govuk-body">
                {{ reportingRestriction }} - {{ offence.reportingRestrictionFlag }}<br/>
                {{ offence.offenceTitle }} - {{ offence.offenceWording }}
              </p>
            {% endfor %}
            {% if totalHearings !== hearingCount %}
              <hr>
            {% endif %}
          </dl>
        {% endfor %}
      </div>
      {{ super() }}
    </div>
    </div>
  </div>
{% endblock %}
{% block bodyEnd %}
  {{ super() }}
  <script>
    // The following function is hiding content and navigation due to screen readers to read behind the visible panel
    function toggleFilters() {
      console.log("here we are")
      var element = document.getElementById("filters");
      var navigation = document.getElementsByClassName("moj-sub-navigation pub-navigation govuk-!-margin-bottom-0");
      var skipLink = document.getElementsByClassName("govuk-skip-link");
      var header = document.getElementsByClassName("govuk-header");
      var backLink = document.getElementsByClassName("govuk-back-link");
      var footer = document.getElementsByClassName("govuk-footer");

      element.classList.toggle("always-hide");
      navigation[0].classList.toggle("always-hide");
      skipLink[0].classList.toggle("always-hide");
      header[0].classList.toggle("always-hide");
      backLink[0].classList.toggle("always-hide");
      footer[0].classList.toggle("always-hide");
      if (element.className.indexOf('always-hide') > 0) {
        document.getElementsByClassName('hide-show-button')[0].innerHTML = '{{ show }}';
      } else {
        document.getElementsByClassName('hide-show-button')[0].innerHTML = '{{ hide }}';

        //This ensures that focus works correctly for screen readers in the filter box.
        var elements = document.getElementsByClassName('govuk-heading-m');
        elements[0].setAttribute("tabindex", "0");
        elements[1].setAttribute("tabindex", "0");
        elements[0].focus();
      }
    }

    document.getElementsByClassName('hide-show-button')[0].addEventListener("click", toggleFilters);

    // Replace apply filters button with localisation text as currently unconfigurable
    document.getElementsByClassName("moj-filter-layout__filter")[0].getElementsByTagName("button")[0].innerHTML = '{{ applyFilters }}';

  </script>
{% endblock %}
